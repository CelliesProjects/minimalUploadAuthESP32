<!doctype HTML>
<html lang="en">
<head>
<title>TEST UPLOAD</title>
<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="icon" href="data:;base64,iVBORw0KGgo=">  <!--prevent favicon requests-->
<style>
button{
    margin:10px;
}
#uploadForm {
    width:350px;
    margin:0 auto;
    background-color:beige;
    text-align:center;
}
#title{
    text-align:center;
    margin:5px;
}
#uploadForm #fileSelection{
    height:50px;
    border:solid 1px lightgrey;
}
#uploadProgressBar{
    margin:10px;
}
#uploadFileButton{
    width:100px;
    height:30px;
    margin:10px;
}
#status{
    margin:5px;
}
.credentials{
    margin:2px;
    display:flex;
}
#username, #password {
    width:48%;
    margin:5px;
    text-align:center;
}
</style>
</head>
<body>
    <form id="uploadForm" enctype="multipart/form-data">
        <p id="title">Simple authenticated upload example<br>for ESP32 and ESPAsyncWebServer</p>
        <p class="credentials">
            <input type="text" id="username" name="username" placeholder="username">
            <input type="password" id="password" name="password" placeholder="password">
        </p>
        <input id="fileSelection" name="file" type="file" />
        <progress id="uploadProgressBar" value="0" max="0"></progress>
        <p id="status">&nbsp;</p>
        <input id="uploadFileButton" type="submit" value="Upload" disabled="disabled"/>
    </form>
<script type="text/javascript">

function uploadProgressHandler(event) {
    const percent = (event.loaded / event.total) * 100;
    document.getElementById('status').innerHTML = Math.round(percent) + "% uploaded. Please wait...";
    var progress = document.getElementById('uploadProgressBar');
    progress.setAttribute("value", event.loaded);
    progress.setAttribute("max", event.total);
}

function startUpload() {
    let data = new FormData();
    data.append('file', document.getElementById('fileSelection').files[0]);

    let request = new XMLHttpRequest();
    request.onerror = function() {
        console.log("** An error occurred during the transaction");
    }
    request.open('POST', '/api/upload');
    //request.open('POST', 'http://192.168.0.106/api/upload'); //debug/remote running of this page

    const user = document.getElementById('username').value;
    const pw = document.getElementById('password').value;

    request.setRequestHeader('Authorization', 'Basic ' + btoa(user + ":" + pw));

    const file = document.getElementById('fileSelection').files[0];
    request.setRequestHeader('FileSize', file.size);

    request.onreadystatechange = function() {
        if (this.readyState == 4) {
            switch (this.status) {
                case 200 :
                    document.getElementById('status').innerHTML = "Upload succes!";
                    window.fileSelection.value = '';
                    window.uploadFileButton.disabled = true;
                    break;
                case 400 :
                    document.getElementById('status').innerHTML = this.responseText;
                    break
                case 401 :
                    document.getElementById('status').innerHTML = "Enter valid username and password";
                    window.uploadFileButton.disabled = false;
                    break;
                default : console.log("problemo " + this.status);
            }
            window.fileSelection.disabled = false;
        }
    };

    request.upload.addEventListener("progress", uploadProgressHandler, false);

    request.addEventListener('load', function() {
        var progress = document.getElementById('uploadProgressBar');
        progress.setAttribute("value", 0);
        progress.setAttribute("max", 0);
    });

    document.getElementById("status").innerHTML = "Starting upload";
    request.send(data);
}

document.getElementById("fileSelection").addEventListener("change", function() {
    if (!window.fileSelection.files[0]) {
        document.getElementById("uploadFileButton").disabled = true;
        return;
    }
    document.getElementById("uploadFileButton").disabled = false;
    document.getElementById("status").innerHTML = "&nbsp;";
});

document.getElementById("uploadFileButton").addEventListener("click", function(event){
    document.getElementById("uploadFileButton").disabled = true;
    document.getElementById("fileSelection").disabled = true;
    event.preventDefault();
    startUpload();
});

</script>
</body>
