<!doctype HTML>
<html lang="en">
<head>
<title>TEST UPLOAD</title>
<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="icon" href="data:;base64,iVBORw0KGgo=">  <!--prevent favicon requests-->
<style>
button{
    margin:10px;
}
#uploadForm {
    width:350px;
    margin:0 auto;
    background-color:beige;
    text-align:center;
}
#title{
    text-align:center;
    margin:5px;
}
#uploadForm #fileSelection{
    height:50px;
    border:solid 1px lightgrey;
}
#uploadProgressBar{
    margin:10px;
}
#uploadFileButton{
    width:100px;
    height:30px;
    margin:10px;
}
#statusText{
    margin:5px;
}
.credentials{
    margin:2px;
    display:flex;
}
#username, #password {
    width:48%;
    margin:5px;
    text-align:center;
}
</style>
</head>
<body>
    <form id="uploadForm" enctype="multipart/form-data">
        <p id="title">Simple authenticated upload example<br>for ESP32 and ESPAsyncWebServer</p>
        <p class="credentials">
            <input type="text" id="username" name="username" placeholder="username">
            <input type="password" id="password" name="password" placeholder="password">
        </p>
        <input id="fileSelection" name="file" type="file" />
        <progress id="uploadProgressBar" value="0" max="0"></progress>
        <p id="statusText">&nbsp;</p>
        <input id="uploadFileButton" type="submit" value="Upload" disabled="disabled"/>
    </form>
<script type="text/javascript">

function startUpload() {
    let request = new XMLHttpRequest();

    request.onerror = function() {
        console.log('An error occurred during the transaction');
    }

    request.onreadystatechange = function() {
        if (this.readyState == 4) {
            switch (this.status) {
                case 200 :
                    window.statusText.innerHTML = 'Upload succes!';
                    window.fileSelection.value = '';
                    window.fileSelection.disabled = false;
                    window.uploadFileButton.disabled = true;
                    break;
                case 400 :
                    window.statusText.innerHTML = this.responseText;
                    window.fileSelection.disabled = false;
                    break
                case 401 :
                    window.statusText.innerHTML = 'Enter valid username and password';
                    window.fileSelection.disabled = false;
                    window.uploadFileButton.disabled = false;
                    break;
                default : console.log('problemo ' + this.status);
            }
        }
    };

    request.upload.addEventListener('progress', function(event) {
        const percent = (event.loaded / event.total) * 100;
        window.statusText.innerHTML = Math.round(percent) + '% uploaded. Please wait...';
        let progress = window.uploadProgressBar;
        progress.setAttribute('value', event.loaded);
        progress.setAttribute('max', event.total);
    });

    request.addEventListener('load', function() {
        let progress = document.getElementById('uploadProgressBar');
        progress.setAttribute('value', 0);
        progress.setAttribute('max', 0);
    });

    request.open('POST', '/api/upload');
    //request.open('POST', 'http://192.168.0.106/api/upload'); //debug/remote running of this page

    request.setRequestHeader('Authorization', 'Basic ' + btoa(window.username.value + ":" + window.password.value));

    const file = window.fileSelection.files[0];
    request.setRequestHeader('FileSize', file.size);

    let data = new FormData();
    data.append('file', file);

    window.statusText.innerHTML = 'Starting upload';

    request.send(data);
}

document.getElementById('fileSelection').addEventListener('change', function() {
    window.uploadFileButton.disabled = this.files[0] ? false : true;
    window.statusText.innerHTML = '&nbsp;';
});

document.getElementById('uploadFileButton').addEventListener('click', function(event){
    event.preventDefault();
    this.disabled = true;
    window.fileSelection.disabled = true;
    startUpload();
});

</script>
</body>
</html>
